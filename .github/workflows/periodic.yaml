name: Periodic actions

# This workflow performs periodic cleanup of AWS resources
# It uses the holodeck cleanup command to remove VPCs tagged with Project=holodeck and Environment=cicd

on:
  schedule:
    - cron: '0 0,12 * * *' # Runs daily at 12AM and 12PM

jobs:
  cleanup:
    runs-on: linux-amd64-cpu4
    strategy:
      matrix:
        aws-region: [us-west-1, us-east-1]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Build holodeck CLI
        run: make build-cli

      - name: Set up AWS CLI
        uses: aws-actions/configure-aws-credentials@v6
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ matrix.aws-region }}

      - name: Identify resources for deletion
        id: identify-resources
        run: |
          # Find VPCs with tags Project=holodeck and Environment=cicd
          vpcs=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Project,Values=holodeck" "Name=tag:Environment,Values=cicd" \
            --query "Vpcs[].VpcId" \
            --output text | tr -d '\r' | tr '\n' ' ')
          echo "Found VPCs: $vpcs"
          echo "AWS_VPC_IDS=$vpcs" >> $GITHUB_ENV

      - name: Clean up VPCs
        if: env.AWS_VPC_IDS != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use the new holodeck cleanup command
          # The AWS_REGION is already set by aws-actions/configure-aws-credentials
          echo "Cleaning up VPCs in region ${{ matrix.aws-region }}: $AWS_VPC_IDS"
          if [ -n "$AWS_VPC_IDS" ]; then
            # The cleanup command can handle multiple VPCs at once
            ./bin/holodeck cleanup $AWS_VPC_IDS || {
              echo "::warning::Some VPCs failed to cleanup in region ${{ matrix.aws-region }}"
              exit 0  # Don't fail the workflow if some cleanups fail
            }
          else
            echo "No VPCs to clean up in region ${{ matrix.aws-region }}"
          fi

      - name: Post cleanup
        run: |
          echo "Cleanup completed."
